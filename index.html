<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>GIF Transparent Generator</title>
  <style>
    body { font-family: sans-serif; background: #111; color: white; padding: 20px; }
    input, button, label { margin: 10px 0; display: block; }
    #generate, #downloadLink { display: none; }
    #preview { margin-top: 20px; max-width: 100%; border: 1px solid #444; }
  </style>
</head>
<body>
  <h2>Créer un GIF avec transparence</h2>
  <input type="file" id="images" multiple accept="image/*">
  <label for="delay">Vitesse (ms/image):</label>
  <input type="number" id="delay" value="200" min="10" max="10000">
  <button id="generate">🧪 Générer le GIF</button>
  <a id="downloadLink" download="mon_gif.gif">📥 Télécharger le GIF</a>
  <br>
  <img id="preview" alt="Aperçu GIF" />

  <script src="https://unpkg.com/gif.js.optimized/dist/gif.worker.js"></script>
  <script src="https://unpkg.com/gif.js.optimized/dist/gif.js"></script>

  <script>
    const input = document.getElementById("images");
    const generateBtn = document.getElementById("generate");
    const delayInput = document.getElementById("delay");
    const preview = document.getElementById("preview");
    const downloadLink = document.getElementById("downloadLink");

    let files = [];

    input.addEventListener("change", () => {
      files = Array.from(input.files).sort((a, b) =>
        a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' })
      );
      generateBtn.style.display = files.length ? "inline-block" : "none";
    });

    generateBtn.addEventListener("click", async () => {
      if (!files.length) return alert("Importe des images d'abord.");

      const delay = parseInt(delayInput.value);
      const firstImg = await loadImage(files[0]);
      const gif = new GIF({
        workers: 2,
        width: firstImg.width,
        height: firstImg.height,
        workerScript: 'https://unpkg.com/gif.js.optimized/dist/gif.worker.js',
        transparent: 0x00FF00, // couleur bidon (sera remplacée par canvas alpha)
      });

      for (const file of files) {
        const img = await loadImage(file);
        const canvas = document.createElement("canvas");
        canvas.width = firstImg.width;
        canvas.height = firstImg.height;
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        gif.addFrame(canvas, { delay, copy: true });
      }

      generateBtn.textContent = "⏳ En cours...";
      gif.on("finished", (blob) => {
        const url = URL.createObjectURL(blob);
        preview.src = url;
        downloadLink.href = url;
        downloadLink.style.display = "inline-block";
        generateBtn.textContent = "🧪 Générer le GIF";
      });

      gif.render();
    });

    function loadImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }
  </script>
</body>
</html>
